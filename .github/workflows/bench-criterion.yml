name: Bench

on:
  pull_request:
    branches: [main]
  merge_group:
    types: [checks_requested]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
    bench-criterion:
        name: Criterion
        runs-on: ubuntu-24.04
        strategy:
          matrix: 
            branchl: [base, head]
        env:
          CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
          MLIR_SYS_190_PREFIX: /usr/lib/llvm-19/
          TABLEGEN_190_PREFIX: /usr/lib/llvm-19/
          LLVM_SYS_191_PREFIX: /usr/lib/llvm-19/
        steps:
            - uses: actions/checkout@v4
            # Install dependencies and free space
            - uses: ./cairo_native/.github/actions/install-linux-deps
            
            - name: Setup rust env
              uses: dtolnay/rust-toolchain@1.89.0
            
            - name: Retreive cached dependecies
              uses: Swatinem/rust-cache@v2
            
            - name: Install deps
              run: make deps
            
            - name: Install critcmp
              run: cargo install critcmp

            - name: Checkout commit ${{ matrix.branch }}
              uses: actions/checkout@v4
              with:
                ref: ${{ github.event.pull_request[matrix.branch].sha }}
            
            - name: Run execution benches in ${{ matrix.branch }}
              run: cargo bench --bench benches -- --save-baseline ${{ matrix.branch }}
            
            - name: Compre HEAD vs BASE
              run: critcmp base head | tee bench-results.md
            
            - name: Find Bench Comment
              continue-on-error: true
              uses: peter-evans/find-comment@v3
              id: fc
              with:
                issue-number: ${{ github.event.pull_request.number }}
                comment-author: "github-actions[bot]"
                body-includes: Criterion results Main vs HEAD

            - name: Create or update bench comment
              continue-on-error: true
              uses: peter-evans/create-or-update-comment@v4
              with:
                comment-id: ${{ steps.fc.outputs.comment-id }}
                issue-number: ${{ github.event.pull_request.number }}
                body-path: bench-results.md
                edit-mode: replace
                
            
